
# 🖨️ WinForms 喷码打印系统

本系统用于控制喷码任务的执行与记录，适用于产线喷码流程中的数据生成、发送、接收及记录管理。系统基于 Windows Forms (.NET 8)，通过 UDP 与喷码机通讯，支持按工单或非工单模式操作，并将记录同步至数据库。

---

## 🚀 功能概览

- ✅ 工单模式：根据生产订单号加载产品编码、行号和数量
- ✅ 非工单模式：手动输入数量喷码，不依赖订单
- ✅ 喷码数据生成（支持校验码编码）
- ✅ UDP 发送喷码数据，等待喷码机返回
- ✅ 打印记录展示于 DataGridView
- ✅ 打印日志实时显示于 ListBox（含时间戳）
- ✅ 自动保存打印记录到数据库
- ✅ 程序关闭前自动检测未保存数据并保存

---

## 📷 系统界面说明

| 控件       | 说明                         |
|------------|------------------------------|
| `textBox1` | 生产订单号输入框              |
| `comboBox1`| 显示对应订单的产品编码和行号  |
| `textBox2` | 打印数量输入框                |
| `checkBox1`| 切换是否“非工单模式”          |
| `button1`  | 执行喷码打印                  |
| `buttontest` | 测试发送与接收功能            |
| `dataGridView1` | 显示喷码记录，每行一条数据 |
| `listBox1` | 打印日志输出，最多保留 100 条 |

---

## 📦 数据表结构：`PenMaJiLu`

用于记录喷码任务的执行结果。

| 字段名     | 类型      | 说明             |
|------------|-----------|------------------|
| `printid`  | varchar   | 打印序号         |
| `MoCode`   | varchar   | 订单号（可为 0） |
| `SotSep`   | varchar   | 行号             |
| `Batch`    | varchar   | 批号（默认 0）   |
| `Sendtime` | datetime  | 数据发送时间     |
| `Printtime`| datetime  | 喷码返回时间     |
| `Result`   | varchar   | 喷码结果         |

---

## 🧩 核心逻辑说明

### ✅ 喷码流程（工单模式）

1. 输入工单号 → 查询料号/行号
2. 选择料号，填写数量
3. 点击“开始喷码”
4. 系统根据数量循环生成编码，发送数据
5. 等待返回值，记录至 DataGridView
6. 自动写入数据库

### ✅ 非工单模式

1. 勾选“非工单模式”
2. 只填写数量 → 不输入工单号
3. 点击“开始喷码”
4. 所有订单号/料号/行号默认为 0
5. 其他流程相同

---

## 💾 数据库写入逻辑

封装在 `SavePrintResultToDatabase()` 方法中：
- 每条打印记录写入 `PenMaJiLu`
- 成功写入后清空 `dataGridView1`
- 支持在程序关闭时自动执行保存

---

## 🛠️ 开发环境

- 框架：.NET 8
- 技术：WinForms + UDP
- 语言：C#
- 数据库：SQL Server
- 字符集：UTF-8

---

## 🧪 示例代码片段

```csharp
var (success, result) = await printerClient.SendAndReceiveAsync(checkvalue);

dataGridView1.Rows.Add(
    i + 1,
    "SCDD24060876",
    "P00001",
    "1",
    "0",
    sendTime,
    printTime,
    result
);
```

---

## 📌 注意事项

- 每次打印完成后自动保存数据库
- 若因异常未保存，程序退出前会尝试保存
- 若 `dataGridView1` 已为空，则不会重复写入

---

## ✅ TODO（待开发）

- [ ] 打印成功标识高亮行
- [ ] 支持批号自定义填写
- [ ] 添加打印模板与格式控制
- [ ] 支持导出 CSV 打印记录

---

## 📧 联系方式

如需支持或反馈，请联系项目维护人。
